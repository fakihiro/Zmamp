#!/bin/bash

# ================================================================
#
# Zmamp
#
# @author Akihiro Fukaya <akihiro.fukaya@seezoo.co.jp>
#
# ================================================================

function _help()
{(
  echo ""
  echo "Usage: Zmamp [start]"
  echo "             [stop]"
  echo "             [httpd] [start|stop|restart|status|conf]"
  echo "             [mysqld] [start|stop|restart|status]"
  echo "             [php] [-v|-cv|-cfg|-a]"
  echo ""
  echo "Options:"
  echo "  start                      Starting the apache and mysql of MAMP"
  echo "  stop                       Stop apache and mysql of MAMP"
  echo "  httpd"
  echo "    start                    Starting the apache of MAMP"
  echo "    stop                     Stop the apache of MAMP"
  echo "    restart                  Restarting the apache of MAMP"
  echo "    status                   Check the status of the apache of MAMP"
  echo "    conf                     Change the httpd.conf"
  echo "  mysqld"
  echo "    start                    Starting the mysqld of MAMP"
  echo "    stop                     Stop the mysqld of MAMP"
  echo "    restart                  Restarting the mysqld of MAMP"
  echo "    status                   Check the status of the mysqld of MAMP"
  echo "  php"
  echo "    -v   | --version         PHP version confirmation of MAMP"
  echo "    -cv  | --change-version  Change PHP version for Default and MAMP"
  echo "    -cfg | --conf            Change the php.ini of the MAMP php"
  echo "    -a                       Develop tool"
)}

function _main()
{(
  prog="Zmamp"

  _BASE_DIR="/Applications/MAMP"
  _BIN_DIR="${_BASE_DIR}/bin"
  _PHP_DIR="${_BIN_DIR}/php"
  _CONF_DIR="${_BASE_DIR}/conf"
  _HTTPD_CONF="${_CONF_DIR}/apache/httpd.conf"

  case ${1} in
    start | stop | status)
      _mamp ${1}
      ;;
    httpd )
      _httpd ${2}
      ;;
    mysqld )
      _mysqld ${2}
      ;;
    php )
      _php ${2}
      ;;
    -h | --help | * )
      help
      ;;
  esac

  return 0
)}

function _mamp()
{
  _httpd && ${1} || return 1

  _mysqld && ${1} || return 1

  return 0
}

function _httpd()
{(
  SERVICE="httpd"

  function _main()
  {(
    case ${1} in
      start | stop | restart | status)
        _${1}
        ;;
      *)
        _help
        ;;
    esac

    return $?
  )}

  # start
  function _start()
  {(
    echo "Start ${SERVICE}."

    _is_running && echo "${SERVICE} already running..." && return 0

    if sudo ${_BIN_DIR}/startApache.sh;then
      _wait "_httpd" "start" && echo " [ OK ]" || echo " [ Failed ]"
    else
      _error "httpd start failed." && return 1
    fi

    return 0
  )}

  # stop
  function _stop()
  {(
    echo "Stop ${SERVICE}."

    ! _is_running && echo "${SERVICE} already stopped." && return 0

    if sudo ${_BIN_DIR}/stopApache.sh;then
      _wait "_httpd" "stop" && echo "[ OK ]" || echo "[ Failed ]"
    else
      _error "httpd stop failed." && return 1
    fi

    return 0
  )}

  # restart
  function _restart()
  {(
    _is_running && _stop
    _start

    return 0
  )}

  # status
  function _status()
  {(
    _is_running && echo "${SERVICE} is running..." || echo "${SERVICE} is stop."
    return 0
  )}

  # _is_running
  function _is_running()
  {(
    # return code
    # 0: Is running
    # 1: Stoped

    ps cax | grep "httpd" > /dev/null

    return $?
  )}

  _main "${1}"

  return 0
)}

#  mysqld main
function _mysqld()
{(
  SERVICE="mysqld"

  function _main()
  {(
      case ${1} in
        start | stop | restart | status )
          _${1}
          ;;
        *)
          _help
          ;;
      esac

      return $?
  )}

  # start
  function _start()
  {(
    _is_running &&  echo "${SERVICE} is already running." && return 0

    echo "Start ${SERVICE}."
    nohup ${_BIN_DIR}/startMysql.sh > /dev/null

    _wait "_mysqld" "start" && echo "[ OK ]" || echo "[ Failed ]"

    return 0
  )}

  # stop
  function _stop()
  {(
    ! _is_running && echo "${SERVICE} is not running." && return 0

    echo "Stop ${SERVICE}."
    nohup ${_BIN_DIR}/stopMysql.sh > /dev/null

    _wait "_mysqld" "stop" && echo "[ OK ]" || echo "[ Failed ]"

    return 0
  )}

  # restart
  function _restart()
  {(
    _is_running && _stop
    _start

    return 0
  )}

  # status
  function _status()
  {(
    _is_running && echo "${SERVICE} is running..." || echo "${SERVICE} is stop."

    return 0
  )}

  # status
  function _is_running()
  {(
    ps cax | grep "mysqld" > /dev/null

    return $?
  )}

  _main "${1}"

  return $?
)}

#  php main
function _php()
{(
  SERVICE="php"

  function _main()
  {
      case ${1} in
        -v | --check-ver)
          _check
          ;;
        -cv | --conf-ver)
          _change
          ;;
        -cfg | --conf)
          _conf
          ;;
        -a)
          _a
          ;;
        *)
          _help
          ;;
      esac

      return $?
  }

  # check php version
  function _check()
  {(
    cat ${_HTTPD_CONF} | grep -e "php5_module\|php7_module" | awk '{print $3}' | sed -e "s#${_PHP_DIR}/##g" | sed -e "s#/.*##g"

    return 0
  )}

  # select php version
  function _change()
  {(
    ans
    php_ver=''
    php_vers=($(ls ${_PHP_DIR} | grep php))

    while :;do
      echo ""
      echo "=="
      echo -n "Now PHP Version: ";check
      echo "=="
      echo ""
      echo "Please select PHP version number."
      -i count=0
      for v in ${php_vers[*]};do
        echo " [${count}] ${v}"
        count=$count+1
      done
      echo " [${count}] exit"
      echo -n "> "
      read ans
      if [ ${ans} -le ${count} ];then
        if [ ${ans} -eq $count ];then
          return 0
        else
          php_ver=${php_vers[${ans}]}
        fi
        break
      fi
    done

    if _edit_httpd_conf "${php_ver}" && _edit_bash_profile "${php_ver}";then
      echo "Changed PHP version to ${php_ver}."
      echo "Httpd restart."
      _httpd restart
    fi
    return 0
  )}

  # php.ini
  function _conf()
  {(
    php_ver="$(check)"
    php_conf="${_PHP_DIR}/${php_ver}/conf/php.ini"
    php_conf_back="${php_conf}.back"

    echo "Now PHP Version: ${php_ver}"
    echo "To change the php.ini file ?"
    if ! _ynselecter;then
      return 0
    fi

    [ ! -f ${php_conf} ] && _error "Default 'php.ini' is not found." && return 1
    [ ! -f php_conf_back ] && cp ${php_conf} ${php_conf}.back

    while vi ${php_conf} || :;do
      echo "Edit the end ?"
      if _ynselecter;then
        echo "Httpd restart ?"
        if _ynselecter;then
          _httpd && restart && break
        else
          break
        fi
      fi
    done

    return 0
  )}

  # php debug
  function _a()
  {(
    path="/tmp/"
    name="$(date "+%Y%m%d%H%I%S").php"
    file="${path}${name}"
    opened="false"

    echo "<?php" > ${file}

    trap 'rm ${file}; exit 0' 1 2 3 15

    if [ ! -f ${file} ];then
      _error "php file is not found." && return 1
    fi

    while vi ${file} || :;do
      echo ""
      php ${file}
      echo ""

      echo "Continue ?"
      if ! _ynselecter;then
        rm ${file}
        break
      fi
    done

    return 0
  )}


  # edit httpd.conf
  function _edit_httpd_conf()
  {(
    before=$(cat ${_HTTPD_CONF} | grep "${_PHP_DIR}" | grep -e "php.*/modules/libphp5.so\|php.*/modules/libphp7.so")
    after=

    if echo ${1} | grep "php7";then
      after="LoadModule php7_module        ${_PHP_DIR}/${1}/modules/libphp7.so"
    else
      after="LoadModule php5_module        ${_PHP_DIR}/${1}/modules/libphp5.so"
    fi

    if sed -i "" -e "s#${before}#${after}#" ${_HTTPD_CONF};then
      return 0
    else
      return 1
    fi
  )}

  # To changed php version, Write to .bash_profile php path
  function _edit_bash_profile()
  {(
    bash_profile="${HOME}/.bash_profile"
    if [ ! -e ${bash_profile} ];then
      echo "${bash_profile} is not found."
      return 0
    fi

    reg="export\\ PATH=${_PHP_DIR}/php.*/bin:\\\$PATH"
    if [ $(cat "${bash_profile}" | grep "${reg}" | wc -l) -eq 1 ];then
      before=$(cat ${bash_profile} | grep "${reg}")
      after="export PATH=${_PHP_DIR}/${1}/bin:\$PATH"
      if ! sed -i "" -e "s#${before}#${after}#" ${bash_profile};then
        return 1
      fi
    else
      echo "${after}" >> ${bash_profile}
      echo "Add 'MAMP PHP PATH' to .bash_profile."
    fi

    echo "Execute 'source ${bash_profile}'"
    return 0
  )}

  _main ${1}

  return $?
)}

#  Waiting to be processed
function _wait()
{(
  end=

  if [ "${2}" = 'start' ];then
    end=0
  elif [ "${2}" = 'stop' ];then
    end=1
  else
    return 1
  fi

  echo -n "Please wait..."
  while :;do
    _is_running
    [ $? -eq ${end} ] && return 0
    echo -n "."
  done
)}

#  Yes or No Selecter
function _ynselecter()
{(
  while true;do
    ans
    echo "Please select. [y/N]"
    echo -n "> "
    read ans
    if [ -z ${ans} ];then
      ans="FALSE"
    fi
    case ${ans} in
      y)
        return 0
        ;;
      N)
        return 1
        ;;
      *)
        ;;
    esac
  done
)}

#  Output error message and Processing end
function _error()
{
  echo "Error: ${1}";

  return 0
}

[ ${#} -le 0 ] && _help && exit 1
_main ${*}

exit 0
